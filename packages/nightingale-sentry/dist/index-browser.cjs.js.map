{"version":3,"file":"index-browser.cjs.js","sources":["../src/index.ts"],"sourcesContent":["import { POB_TARGET } from 'pob-babel';\nimport type {\n  addBreadcrumb,\n  captureException,\n  captureMessage,\n} from '@sentry/core';\nimport * as SentryNode from '@sentry/node';\nimport type { User } from '@sentry/types';\nimport { Severity } from '@sentry/types';\nimport { Level } from 'nightingale-levels';\nimport type { LogRecord, Handle, Metadata, Handler } from 'nightingale-types';\n\nconst mapToSentryLevel: Record<Level, Severity> = {\n  [Level.TRACE]: Severity.Debug,\n  [Level.DEBUG]: Severity.Debug,\n  [Level.INFO]: Severity.Info,\n  [Level.NOTICE]: Severity.Log,\n  [Level.WARNING]: Severity.Warning,\n  [Level.ERROR]: Severity.Error,\n  [Level.CRITICAL]: Severity.Critical,\n  [Level.FATAL]: Severity.Fatal,\n  [Level.EMERGENCY]: Severity.Critical,\n  // not a level\n  [Level.ALL]: Severity.Error,\n};\n\nexport interface MetadataWithError extends Metadata {\n  error?: Error;\n}\n\nexport interface Options {\n  getUser?: <T extends MetadataWithError>(\n    record: LogRecord<T>,\n  ) => User | undefined;\n  getTags?: <T extends MetadataWithError>(\n    record: LogRecord<T>,\n  ) => Record<string, string>;\n  getBreadcrumbCategory?: <T extends Metadata>(\n    record: LogRecord<T>,\n  ) => string | undefined;\n  getBreadcrumbType?: <T extends Metadata>(\n    record: LogRecord<T>,\n  ) => string | undefined;\n  shouldSendAsException?: <T extends MetadataWithError>(\n    record: LogRecord<T>,\n  ) => boolean;\n  shouldSendAsBreadcrumb?: <T extends Metadata>(\n    record: LogRecord<T>,\n  ) => boolean;\n}\n\nexport interface SentryRequiredMethods {\n  addBreadcrumb: typeof addBreadcrumb;\n  captureException: typeof captureException;\n  captureMessage: typeof captureMessage;\n}\n\nconst createHandler = <S extends SentryRequiredMethods>(\n  Sentry: S,\n  {\n    getUser = () => undefined,\n    getTags = () => ({}),\n    getBreadcrumbCategory = () => undefined,\n    getBreadcrumbType = () => undefined,\n    shouldSendAsException = <T extends Metadata>(record: LogRecord<T>) =>\n      record.metadata?.error !== undefined &&\n      record.metadata.unhandled !== true,\n    shouldSendAsBreadcrumb = <T extends Metadata>(record: LogRecord<T>) =>\n      false,\n  }: Options = {},\n): Handle => {\n  return <T extends MetadataWithError>(record: LogRecord<T>) => {\n    const { key, level, metadata, extra } = record;\n\n    if (shouldSendAsException(record)) {\n      const error = metadata?.error || record.message;\n\n      const extraData: Record<string, unknown> = { ...metadata, ...extra };\n      delete extraData.error;\n\n      Sentry.captureException(error, {\n        level: mapToSentryLevel[level] || Severity.Error,\n        user: getUser(record),\n        tags: {\n          loggerKey: key,\n          ...getTags(record),\n        },\n        extra: extraData,\n      });\n    } else if (shouldSendAsBreadcrumb(record)) {\n      Sentry.addBreadcrumb({\n        level: mapToSentryLevel[level] || Severity.Error,\n        category: getBreadcrumbCategory(record),\n        type: getBreadcrumbType(record),\n        message: record.message,\n        data: record.metadata,\n        timestamp: record.datetime.getTime(),\n      });\n    }\n  };\n};\n\nexport class SentryHandler<S extends SentryRequiredMethods> implements Handler {\n  minLevel: Level;\n\n  handle: Handle;\n\n  constructor(Sentry: string | S, minLevel: Level, options?: Options) {\n    this.minLevel = minLevel;\n    if (POB_TARGET === 'node' && typeof Sentry === 'string') {\n      console.warn(\n        'nightingale-sentry: Passing DSN directly is deprecated, pass Sentry instead and init in your app.',\n      );\n      SentryNode.init({ dsn: Sentry });\n      this.handle = createHandler(SentryNode, options);\n    } else {\n      this.handle = createHandler<S>(Sentry as S, options);\n    }\n  }\n}\n"],"names":["mapToSentryLevel","Level","TRACE","Severity","Debug","DEBUG","INFO","Info","NOTICE","Log","WARNING","Warning","ERROR","Error","CRITICAL","Critical","FATAL","Fatal","EMERGENCY","ALL","createHandler","Sentry","getUser","undefined","getTags","getBreadcrumbCategory","getBreadcrumbType","shouldSendAsException","record","metadata","error","unhandled","shouldSendAsBreadcrumb","key","level","extra","message","extraData","_extends","captureException","user","tags","loggerKey","addBreadcrumb","category","type","data","timestamp","datetime","getTime","SentryHandler","minLevel","options","handle"],"mappings":"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"}