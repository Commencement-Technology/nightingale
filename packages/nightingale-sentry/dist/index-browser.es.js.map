{"version":3,"file":"index-browser.es.js","sources":["../src/index.ts"],"sourcesContent":["import { POB_TARGET } from 'pob-babel';\nimport type {\n  addBreadcrumb,\n  captureException,\n  captureMessage,\n} from '@sentry/core';\nimport * as SentryNode from '@sentry/node';\nimport type { User } from '@sentry/types';\nimport { Severity } from '@sentry/types';\nimport { Level } from 'nightingale-levels';\nimport type { LogRecord, Handle, Metadata, Handler } from 'nightingale-types';\n\nconst mapToSentryLevel: Record<Level, Severity> = {\n  [Level.TRACE]: Severity.Debug,\n  [Level.DEBUG]: Severity.Debug,\n  [Level.INFO]: Severity.Info,\n  [Level.NOTICE]: Severity.Log,\n  [Level.WARNING]: Severity.Warning,\n  [Level.ERROR]: Severity.Error,\n  [Level.CRITICAL]: Severity.Critical,\n  [Level.FATAL]: Severity.Fatal,\n  [Level.EMERGENCY]: Severity.Critical,\n  // not a level\n  [Level.ALL]: Severity.Error,\n};\n\nexport interface MetadataWithError extends Metadata {\n  error?: Error;\n}\n\nexport interface Options {\n  getUser?: <T extends MetadataWithError>(\n    record: LogRecord<T>,\n  ) => User | undefined;\n  getTags?: <T extends MetadataWithError>(\n    record: LogRecord<T>,\n  ) => Record<string, string>;\n  getBreadcrumbCategory?: <T extends Metadata>(\n    record: LogRecord<T>,\n  ) => string | undefined;\n  getBreadcrumbType?: <T extends Metadata>(\n    record: LogRecord<T>,\n  ) => string | undefined;\n  shouldSendAsException?: <T extends MetadataWithError>(\n    record: LogRecord<T>,\n  ) => boolean;\n  shouldSendAsBreadcrumb?: <T extends Metadata>(\n    record: LogRecord<T>,\n  ) => boolean;\n}\n\nexport interface SentryRequiredMethods {\n  addBreadcrumb: typeof addBreadcrumb;\n  captureException: typeof captureException;\n  captureMessage: typeof captureMessage;\n}\n\nconst createHandler = <S extends SentryRequiredMethods>(\n  Sentry: S,\n  {\n    getUser = () => undefined,\n    getTags = () => ({}),\n    getBreadcrumbCategory = () => undefined,\n    getBreadcrumbType = () => undefined,\n    shouldSendAsException = <T extends Metadata>(record: LogRecord<T>) =>\n      record.metadata?.error !== undefined &&\n      record.metadata.unhandled !== true,\n    shouldSendAsBreadcrumb = <T extends Metadata>(record: LogRecord<T>) =>\n      false,\n  }: Options = {},\n): Handle => {\n  return <T extends MetadataWithError>(record: LogRecord<T>) => {\n    const { key, level, metadata, extra } = record;\n\n    if (shouldSendAsException(record)) {\n      const error = metadata?.error || record.message;\n\n      const extraData: Record<string, unknown> = { ...metadata, ...extra };\n      delete extraData.error;\n\n      Sentry.captureException(error, {\n        level: mapToSentryLevel[level] || Severity.Error,\n        user: getUser(record),\n        tags: {\n          loggerKey: key,\n          ...getTags(record),\n        },\n        extra: extraData,\n      });\n    } else if (shouldSendAsBreadcrumb(record)) {\n      Sentry.addBreadcrumb({\n        level: mapToSentryLevel[level] || Severity.Error,\n        category: getBreadcrumbCategory(record),\n        type: getBreadcrumbType(record),\n        message: record.message,\n        data: record.metadata,\n        timestamp: record.datetime.getTime(),\n      });\n    }\n  };\n};\n\nexport class SentryHandler<S extends SentryRequiredMethods> implements Handler {\n  minLevel: Level;\n\n  handle: Handle;\n\n  constructor(Sentry: string | S, minLevel: Level, options?: Options) {\n    this.minLevel = minLevel;\n    if (POB_TARGET === 'node' && typeof Sentry === 'string') {\n      console.warn(\n        'nightingale-sentry: Passing DSN directly is deprecated, pass Sentry instead and init in your app.',\n      );\n      SentryNode.init({ dsn: Sentry });\n      this.handle = createHandler(SentryNode, options);\n    } else {\n      this.handle = createHandler<S>(Sentry as S, options);\n    }\n  }\n}\n"],"names":["mapToSentryLevel","Level","TRACE","Severity","Debug","DEBUG","INFO","Info","NOTICE","Log","WARNING","Warning","ERROR","Error","CRITICAL","Critical","FATAL","Fatal","EMERGENCY","ALL","createHandler","Sentry","getUser","undefined","getTags","getBreadcrumbCategory","getBreadcrumbType","shouldSendAsException","record","metadata","error","unhandled","shouldSendAsBreadcrumb","key","level","extra","message","extraData","captureException","user","tags","loggerKey","addBreadcrumb","category","type","data","timestamp","datetime","getTime","SentryHandler","minLevel","options","handle"],"mappings":"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"}